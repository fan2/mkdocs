
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="在别处或在路上">
      
      
        <meta name="author" content="Cliff Fan">
      
      
        <link rel="canonical" href="https://duetorun.com/blog/20231007/a64-memory-barrier/">
      
      
        <link rel="prev" href="../c-pointer-array-crossref/">
      
      
        <link rel="next" href="../a64-oneway-barrier/">
      
      
      <link rel="icon" href="../../../assets/hold_yourself.jpg">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.34">
    
    
      
        <title>ARM64 Memory Barriers - ElseWhere</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.35f28582.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-XGW41EGL31"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-XGW41EGL31",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-XGW41EGL31",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  

  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#isbinstruction_synchronization_barrier" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="ElseWhere" class="md-header__button md-logo" aria-label="ElseWhere" data-md-component="logo">
      
  <img src="../../../assets/hold_yourself.jpg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            ElseWhere
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              ARM64 Memory Barriers
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1M8 13h8v-2H8zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4a5 5 0 0 0 5-5 5 5 0 0 0-5-5"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="indigo"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5M7 15a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../about/" class="md-tabs__link">
        
  
    
  
  About

      </a>
    </li>
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../" class="md-tabs__link">
          
  
  Blog

        </a>
      </li>
    
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../link/" class="md-tabs__link">
        
  
    
  
  Link

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
                
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" hidden>
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="ElseWhere" class="md-nav__button md-logo" aria-label="ElseWhere" data-md-component="logo">
      
  <img src="../../../assets/hold_yourself.jpg" alt="logo">

    </a>
    ElseWhere
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../about/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    About
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Blog
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Blog
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      <a href="../../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Blog
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Archive
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            Archive
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2024/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2023/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2022/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2021/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2021
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2020/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2020
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2019/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2019
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2018/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2018
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2017/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2017
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2015/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2015
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2009/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2009
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3" >
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Categories
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            Categories
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/cs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/arm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    arm
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/c/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    c
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/cpp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cpp
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/editor/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    editor
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/elf/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    elf
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/excerpt/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    excerpt
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/git/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    git
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/linux/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    linux
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/macos/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    macOS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/markdown/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    markdown
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/material/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    material
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/mkdocs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    mkdocs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/nginx/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    nginx
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/python/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    python
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/resource/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    resource
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/shell/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    shell
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/toolchain/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    toolchain
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/ubuntu/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ubuntu
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/vim/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    vim
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/webdav/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    webDAV
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/wiki/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    wiki
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/zsh/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    zsh
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../link/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Link
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
                
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#isbinstruction_synchronization_barrier" class="md-nav__link">
    <span class="md-ellipsis">
      ISB(Instruction Synchronization Barrier)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dmbdata_memory_barrier" class="md-nav__link">
    <span class="md-ellipsis">
      DMB(Data Memory Barrier)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dsbdata_synchronization_barrier" class="md-nav__link">
    <span class="md-ellipsis">
      DSB(Data Synchronization Barrier)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#parameters_for_dmbdsb" class="md-nav__link">
    <span class="md-ellipsis">
      parameters for DMB/DSB
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#barrier_usage_scenarios" class="md-nav__link">
    <span class="md-ellipsis">
      barrier usage scenarios
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    <span class="md-ellipsis">
      references
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content md-content--post" data-md-component="content">
    <div class="md-sidebar md-sidebar--post" data-md-component="sidebar" data-md-type="navigation">
      <div class="md-sidebar__scrollwrap">
        <div class="md-sidebar__inner md-post">
          <nav class="md-nav md-nav--primary">
            <div class="md-post__back">
              <div class="md-nav__title md-nav__container">
                <a href="../../" class="md-nav__link">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
                  <span class="md-ellipsis">
                    Back to index
                  </span>
                </a>
              </div>
            </div>
            
              <div class="md-post__authors md-typeset">
                
                  <div class="md-profile md-post__profile">
                    <span class="md-author md-author--long">
                      <img src="https://duetorun.com/assets/carve_yourself.jpg" alt="Cliff Fan">
                    </span>
                    <span class="md-profile__description">
                      <strong>
                        
                          Cliff Fan
                        
                      </strong>
                      <br>
                      Just do IT
                    </span>
                  </div>
                
              </div>
            
            <ul class="md-post__meta md-nav__list">
              <li class="md-nav__item md-nav__item--section">
                <div class="md-post__title">
                  <span class="md-ellipsis">
                    Metadata
                  </span>
                </div>
                <nav class="md-nav">
                  <ul class="md-nav__list">
                    <li class="md-nav__item">
                      <div class="md-nav__link">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 19H5V8h14m-3-7v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-1V1m-1 11h-5v5h5z"/></svg>
                        <time datetime="2023-10-07 10:00:00" class="md-ellipsis">Oct 7, 2023</time>
                      </div>
                    </li>
                    
                    
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 3v15h3V3zm3 2 4 13 3-1-4-13zM5 5v13h3V5zM3 19v2h18v-2z"/></svg>
                          <span class="md-ellipsis">
                            in
                            
                              <a href="../../category/arm/">arm</a></span>
                        </div>
                      </li>
                    
                    
                      
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20a8 8 0 0 0 8-8 8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8m0-18a10 10 0 0 1 10 10 10 10 0 0 1-10 10C6.47 22 2 17.5 2 12A10 10 0 0 1 12 2m.5 5v5.25l4.5 2.67-.75 1.23L11 13V7z"/></svg>
                          <span class="md-ellipsis">
                            
                              11 min read
                            
                          </span>
                        </div>
                      </li>
                    
                    <!-- Add by Cliff.Fan, 29Mar24. -->
                    <li class="md-nav__item">
                      <div class="md-nav__link">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m19 1-5 5v11l5-4.5zm2 4v13.5c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5V6c-1.45-1.1-3.55-1.5-5.5-1.5S2.45 4.9 1 6v14.65c0 .25.25.5.5.5.1 0 .15-.05.25-.05C3.1 20.45 5.05 20 6.5 20c1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.3 4.75 1.05.1.05.15.05.25.05.25 0 .5-.25.5-.5V6c-.6-.45-1.25-.75-2-1M10 18.41C8.75 18.09 7.5 18 6.5 18c-1.06 0-2.32.19-3.5.5V7.13c.91-.4 2.14-.63 3.5-.63s2.59.23 3.5.63z"/></svg>
                        <span class="md-ellipsis" id="busuanzi_container_page_pv">
                          PV：<span id="busuanzi_value_page_pv">N/A</span>
                        </span>
                      </div>
                    </li>
                  </ul>
                </nav>
              </li>
            </ul>
          </nav>
          
        </div>
      </div>
    </div>
    <article class="md-content__inner md-typeset">
      
        
  
  

<nav class="md-tags" >
  
    
    
    
      <span class="md-tag">ISB</span>
    
  
    
    
    
      <span class="md-tag">DMB</span>
    
  
    
    
    
      <span class="md-tag">DSB</span>
    
  
</nav>



  <h1>ARM64 Memory Barriers</h1>

<p>On most modern uniprocessors memory operations are not executed in the order specified by the program code. In single threaded programs all operations <em>appear to</em> have been executed in the order specified, with all out-of-order execution hidden to the programmer – however in multi-threaded environments (or when interfacing with other hardware via memory buses) this can lead to problems. To avoid problems, <a href="https://en.wikipedia.org/wiki/Memory_barrier">memory barriers</a> can be used in these cases.</p>
<!-- more -->

<p><a href="https://developer.arm.com/documentation/den0042/latest/Memory-Ordering">ARM Cortex-R Series Programmer's Guide</a> | Chapter 10 Memory Ordering:</p>
<p>A memory barrier is an instruction that requires the processor to apply an ordering <em>constraint</em> between memory operations that occur before and after the memory barrier instruction in the program.</p>
<p><a href="https://developer.arm.com/documentation/den0024/latest">ARM Cortex-A Series Programmer's Guide for ARMv8-A</a> | Chapter 13 Memory Ordering:</p>
<p>If you are an application developer, hardware interaction is probably through a device driver, the interaction with other cores is through <a href="https://en.wikipedia.org/wiki/Pthreads">Pthreads</a> or another multithreading API, and the interaction with a paged memory system is through the operating system. In all of these cases, the memory ordering issues are taken care of for you by the relevant code. However, if you are writing the operating system kernel or device drivers, or implementing a hypervisor, JIT compiler, or multithreading library, you must have a good understanding of the memory ordering rules of the ARM Architecture. You must <strong>ensure</strong> that where your code requires <em>explicit</em> ordering of memory accesses, you are able to achieve this through the correct use of <em><code>barriers</code></em>.</p>
<p>The ARM architecture includes barrier instructions to <strong>force</strong> access <em>ordering</em> and access <em>completion</em> at a specific point. In some architectures, similar instructions are known as a <em>fence</em>(membar, memory fence).</p>
<p>If you are writing code where ordering is important, see <em>Appendix J7 Barrier Litmus Tests in the ARM Architecture Reference Manual - ARMv8, for ARMv8-A architecture profile</em> and <em>Appendix G Barrier Litmus Tests in the ARM Architecture Reference Manual ARMv7-A/R Edition</em>, which includes many worked examples.</p>
<p>The <em>ARM Architecture Reference Manual</em> defines certain key words, in particular, the terms <em><code>observe</code></em> and must be <em><code>observed</code></em>. In typical systems, this defines how the bus interface of a master, for example, a core or GPU and the interconnect, must handle bus transactions. Only masters are able to <strong>observe</strong> transfers. All bus transactions are initiated by a master. The order that a master performs transactions in is not necessarily the same order that such transactions complete at the slave device, because transactions might be <strong>re-ordered</strong> by the interconnect unless some ordering is explicitly <strong>enforced</strong>.</p>
<p>A simple way to describe observability is to say that </p>
<blockquote>
<p>I have observed your write when I can read what you wrote and <br />
I have observed your read when I can no longer change the value you read.</p>
</blockquote>
<p>where both I and you refer to cores or other masters in the system.</p>
<p>There are three types of barrier instruction provided by the architecture:</p>
<h2 id="isbinstruction_synchronization_barrier">ISB(Instruction Synchronization Barrier)<a class="headerlink" href="#isbinstruction_synchronization_barrier" title="Permanent link">#</a></h2>
<p><a href="https://developer.arm.com/documentation/102336/latest/Instruction-barriers">Instruction barriers</a></p>
<p><a href="https://developer.arm.com/documentation/ddi0602/latest/Base-Instructions/ISB--Instruction-synchronization-barrier-">ISB: Instruction synchronization barrier</a>: This instruction flushes the pipeline in the PE(<a href="https://developer.arm.com/documentation/102404/latest/Common-architecture-terms">Processing Element</a>) and is a context synchronization event.</p>
<p>This is used to guarantee that any <em>subsequent</em> instructions are fetched, again, so that privilege and access are checked with the current MMU configuration. It is used to <strong>ensure</strong> any previously executed context-changing operations, such as writes to system control registers, have <strong><em>completed</em></strong> by the time the <code>ISB</code> completes. In hardware terms, this might mean that the instruction pipeline is <strong><em>flushed</em></strong>, for example. Typical uses of this would be in memory management, cache control, and context switching code, or where code is being moved about in memory.</p>
<p>The ARMv8 architecture defines <em>context</em> as the state of the system registers and <em>context-changing operations</em> as things like cache, TLB, and branch predictor maintenance operations, or changes to system control registers, for example, <code>SCTLR_EL1</code>, <code>TCR_EL1</code>, and <code>TTBRn_EL1</code>. The effect of such a context-changing operation is only guaranteed to be seen after a <em>context synchronization event</em>.</p>
<p>There are three kinds of context synchronization event:</p>
<ul>
<li>Taking an exception.</li>
<li>Returning from an exception.</li>
<li>Instruction Synchronization Barrier (<code>ISB</code>).</li>
</ul>
<p>An <code>ISB</code> flushes the pipeline, and re-fetches the instructions from the cache or memory and ensures that the effects of any completed context-changing operation before the <code>ISB</code> are visible to any instruction after the <code>ISB</code>. It also ensures that any context-changing operations after the <code>ISB</code> instruction only take effect after the <code>ISB</code> has been executed and are not seen by instructions before the <code>ISB</code>. This does not mean that an <code>ISB</code> is required after each instruction that modifies a processor register. For example, reads or writes to <code>PSTATE</code> fields, <code>ELRs</code>, <code>SPs</code> and <code>SPSRs</code> occur in program order relative to other instructions.</p>
<p>This example shows how to enable the floating-point unit and <code>NEON</code>, which you can do in AArch64 by writing to bit[20] of the <code>CPACR_EL1</code> register. The <code>ISB</code> is a context synchronization event that guarantees that the enable is complete before any subsequent or <code>NEON</code> instructions are executed.</p>
<div class="language-asm highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">MRS</span><span class="w"> </span><span class="no">X1</span><span class="p">,</span><span class="w"> </span><span class="no">CPACR_EL1</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="nf">ORR</span><span class="w"> </span><span class="no">X1</span><span class="p">,</span><span class="w"> </span><span class="no">X1</span><span class="p">,</span><span class="w"> </span><span class="c1">#(0x3 &lt;&lt; 20)</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="nf">MSR</span><span class="w"> </span><span class="no">CPACR_EL1</span><span class="p">,</span><span class="w"> </span><span class="no">X1</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="nf">ISB</span>
</span></code></pre></div>
<h2 id="dmbdata_memory_barrier">DMB(Data Memory Barrier)<a class="headerlink" href="#dmbdata_memory_barrier" title="Permanent link">#</a></h2>
<p><a href="https://developer.arm.com/documentation/102336/latest/Data-Memory-Barrier">Data Memory Barrier</a></p>
<p><a href="https://developer.arm.com/documentation/ddi0602/latest/Base-Instructions/DMB--Data-memory-barrier-">DMB: Data memory barrier.</a>: This instruction is a memory barrier that ensures the ordering of observations of memory accesses.</p>
<p>This prevents re-ordering of data accesses instructions across the barrier instruction. All data accesses, that is, loads or stores, but not instruction fetches, performed by this processor before the <code>DMB</code>, are <strong>visible</strong> to all other masters within the specified shareability domain before any of the data accesses after the <code>DMB</code>.</p>
<p>For example:</p>
<blockquote>
<p>Pay attention: <code>ADD</code> is not data accessing instructions.</p>
</blockquote>
<div class="language-asm highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="nf">LDR</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x1</span><span class="p">]</span><span class="w">    </span><span class="c1">// Must be seen by the memory system before the STR below.</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="nf">DMB</span><span class="w"> </span><span class="no">ISHLD</span><span class="w">       </span><span class="c1">// Inner shareable: Load - Load, Load - Store</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="nf">ADD</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="mi">#1</span><span class="w">      </span><span class="c1">// May be executed before or after the memory system sees LDR.</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="nf">STR</span><span class="w"> </span><span class="no">x3</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x4</span><span class="p">]</span><span class="w">    </span><span class="c1">// Must be seen by the memory system after the LDR above.</span>
</span></code></pre></div>
<p>It also <strong>ensures</strong> that any explicit preceding data or unified cache maintenance operations have <em>completed before</em> any subsequent data accesses are executed.</p>
<div class="language-asm highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="nf">DC</span><span class="w"> </span><span class="no">CSW</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span><span class="w">      </span><span class="c1">// Data clean by Set/way</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="nf">LDR</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x1</span><span class="p">]</span><span class="w">    </span><span class="c1">// Effect of data cache clean might not be seen by this instruction</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="nf">DMB</span><span class="w"> </span><span class="no">ISH</span><span class="w">         </span><span class="c1">// Inner shareable: Any - Any</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="nf">LDR</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x3</span><span class="p">]</span><span class="w">    </span><span class="c1">// Effect of data cache clean will be seen by this instruction</span>
</span></code></pre></div>
<p>Maintenance instructions related to data cache and unified cache(such as <code>DC</code>) are actually also considered data access instructions. Therefore, the data cache maintenance instructions before the <code>DMB</code> instruction must be executed before the memory access instructions after the DMB instruction.</p>
<p>From the analysis of the above examples, it can be seen that the <code>DMB</code> instruction focuses on the sequence of memory access and does not need to care when the memory access instructions are executed. The data access instructions before the <code>DMB</code> must be <strong><em>observed</em></strong> by the data access instructions after the <code>DMB</code>.</p>
<h2 id="dsbdata_synchronization_barrier">DSB(Data Synchronization Barrier)<a class="headerlink" href="#dsbdata_synchronization_barrier" title="Permanent link">#</a></h2>
<p><a href="https://developer.arm.com/documentation/102336/latest/Data-Synchronization-Barrier">Data Synchronization Barrier</a></p>
<p><a href="https://developer.arm.com/documentation/ddi0602/2024-06/Base-Instructions/DSB--Data-synchronization-barrier-">DSB: Data synchronization barrier.</a>: This instruction is a memory barrier that ensures the completion of memory accesses.</p>
<p>This <strong>enforces</strong> the same ordering as the Data Memory Barrier (<code>DMB</code>), but has the additional effect of blocking execution of <em>any</em> further instructions, <em>not</em> just loads or stores, or both, until synchronization is complete. This can be used to <strong>prevent</strong> execution of a <code>SEV</code> instruction, for instance, that would <em>signal</em> to other cores that an event occurred. It <strong>waits</strong> until all cache, TLB and branch predictor maintenance operations issued by this processor have completed for the specified shareability domain.</p>
<p>The <code>DSB</code> instruction is much stricter than the <code>DMB</code> instruction. <em>Any</em> instruction after the <code>DSB</code> must meet the following two conditions before it can start executing.</p>
<ul>
<li>All data access instructions (memory access instructions) before the <code>DSB</code> instruction must be executed.</li>
<li>The cache, branch prediction, TLB and other maintenance instructions before the <code>DSB</code> instruction must also be executed.</li>
</ul>
<p>The instructions after the <code>DSB</code> instruction can only be executed after these two conditions are met. Note that the instructions after the <code>DSB</code> refer to <em>any</em> instructions.</p>
<p>Compared with the <code>DMB</code> instruction, the <code>DSB</code> instruction specifies under what conditions it can be executed, while the <code>DMB</code> instruction only constrains the execution order of the data access instructions before and after the barrier.</p>
<p>Example 1: The CPU executes the following 3 instructions.</p>
<div class="language-asm highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="nf">LDR</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x1</span><span class="p">]</span><span class="w">    </span><span class="c1">// Access must have completed before DSB can complete</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="nf">DSB</span><span class="w"> </span><span class="no">ISH</span><span class="w">         </span><span class="c1">// Inner shareable: Any - Any</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="nf">ADD</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="no">x3</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span><span class="w">  </span><span class="c1">// Cannot be executed until DSB completes</span>
</span></code></pre></div>
<p>The <code>ADD</code> instruction must wait for the <code>DSB</code> instruction to be executed before it can start executing. It cannot be reordered before the <code>LDR</code> instruction.</p>
<p>If the <code>DSB</code> instruction is replaced with the <code>DMB</code> instruction, the <code>ADD</code> instruction can be reordered before the <code>LDR</code> instruction.</p>
<p>Example 2: The CPU executes the following 4 instructions.</p>
<div class="language-asm highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="c1">// DC ISW, x5</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="nf">DC</span><span class="w"> </span><span class="no">CIVA</span><span class="w"> </span><span class="no">x5</span><span class="w">      </span><span class="c1">// operation must have completed before DSB can complete</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="nf">STR</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x1</span><span class="p">]</span><span class="w">    </span><span class="c1">// Access must have completed before DSB can complete</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="nf">DSB</span><span class="w"> </span><span class="no">ISH</span><span class="w">         </span><span class="c1">// Inner shareable: Any - Any</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="nf">ADD</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="mi">#3</span><span class="w">  </span><span class="c1">// Cannot be executed until DSB completes</span>
</span></code></pre></div>
<p>The first instruction is the <code>DC</code> instruction, which clears and invalidates the data cache corresponding to the virtual address (X5 register).<br />
The second instruction stores the value of the X0 register to the address hold by register x1. The third instruction is the <code>DSB</code> instruction. The fourth instruction is the <code>ADD</code> instruction, which adds 3 to the value of the X2 register.</p>
<p>The <code>DC</code> instruction and the <code>STR</code> instruction must be executed before the <code>DSB</code> instruction. The <code>ADD</code> instruction must wait until the <code>DSB</code> instruction is executed before it can start executing. Although the <code>ADD</code> instruction is not a data access instruction, it must wait until the <code>DSB</code> instruction is executed before it can start executing.</p>
<p>In a multi-core system, cache and TLB maintenance instructions are broadcast to other CPU cores to perform local related maintenance operations. The <code>DSB</code> instruction is considered to be completed only when it waits for these broadcasts and receives the acknowledgement signal sent by other CPU cores. Therefore, when the <code>DSB</code> instruction is executed, the other CPU cores have seen that the first <code>DC</code> instruction has been executed.</p>
<h2 id="parameters_for_dmbdsb">parameters for DMB/DSB<a class="headerlink" href="#parameters_for_dmbdsb" title="Permanent link">#</a></h2>
<p><a href="https://developer.arm.com/documentation/102336/latest/Limiting-the-scope-of-memory-barriers">Limiting the scope of memory barriers</a></p>
<p>As you can see from the above examples, the <code>DMB</code> and <code>DSB</code> instructions take a parameter which specifies the types of access to which the barrier operates, <em>before</em> or <em>after</em>, and a <a href="../../20231006/a64-memory-ordering/">shareability domain</a> to which it applies.</p>
<p>The argument that defines which type of memory accesses are ordered by the memory barrier and the Shareability domain over which the instruction must operate. This <em>scope</em> effectively defines which Observers the ordering imposed by the barriers extend to.</p>
<p>According to the scope of sharing, the cache can be divided into 4 share domains - non-shareable domain, inner shareable domain, outer shareable domain and system shareable domain. The purpose of the shared domain is to specify the scope of cache consistency for all hardware units that can access memory, which is mainly used for cache maintenance instructions and memory barrier instructions.</p>
<ol>
<li>If an area is marked as <code>Non-shareable</code>, it means that it can only be accessed by one processor and cannot be accessed by other processors.</li>
<li>If an area is marked as <code>Inner Shareable</code>, it means that the processors in this area can access these shared caches, but the hardware units in other areas of the system (such as DMA devices, GPUs, etc.) cannot access them.</li>
<li>If an area is marked as <code>Outer Shareable</code>, it means that the processors in this area and the hardware units with memory access capabilities (such as GPUs, etc.) can access and share caches with each other.</li>
<li>If a memory area is marked as <code>System Shareable</code>(<em>Full system</em>), it means that all units in the system that access memory can access and share this area.</li>
</ol>
<table>
<thead>
<tr>
<th>&lt;option&gt;</th>
<th>Ordered Accesses (before - after)</th>
<th>Shareability Domain</th>
</tr>
</thead>
<tbody>
<tr>
<td>OSHLD</td>
<td>Load - Load, Load - Store</td>
<td>Outer shareable</td>
</tr>
<tr>
<td>OSHST</td>
<td>Store - Store</td>
<td><em>ditto</em></td>
</tr>
<tr>
<td>OSH</td>
<td>Any - Any</td>
<td><em>ditto</em></td>
</tr>
<tr>
<td>NSHLD</td>
<td>Load - Load, Load - Store</td>
<td>Non-shareable</td>
</tr>
<tr>
<td>NSHST</td>
<td>Store - Store</td>
<td><em>ditto</em></td>
</tr>
<tr>
<td>NSH</td>
<td>Any - Any</td>
<td><em>ditto</em></td>
</tr>
<tr>
<td>ISHLD</td>
<td>Load -Load, Load - Store</td>
<td>Inner shareable</td>
</tr>
<tr>
<td>ISHST</td>
<td>Store - Store</td>
<td><em>ditto</em></td>
</tr>
<tr>
<td>ISH</td>
<td>Any - Any</td>
<td><em>ditto</em></td>
</tr>
<tr>
<td>LD</td>
<td>Load -Load, Load - Store</td>
<td>Full system</td>
</tr>
<tr>
<td>ST</td>
<td>Store - Store</td>
<td><em>ditto</em></td>
</tr>
<tr>
<td>SY</td>
<td>Any - Any</td>
<td><em>ditto</em></td>
</tr>
</tbody>
</table>
<p>The ordered access field specifies which classes of accesses the barrier operates on. There are three options.</p>
<p><strong>Load - Load/Store</strong></p>
<blockquote>
<p>This means that the barrier requires all <code>loads</code> to complete <em>before</em> the barrier but does not require stores to complete.<br />
Both <code>loads</code> and <code>stores</code> that appear <em>after</em> the barrier in program order must wait for the barrier to complete.</p>
</blockquote>
<p><strong>Store - Store</strong></p>
<blockquote>
<p>This means that the barrier <em>only</em> affects store accesses and that loads can still be freely re-ordered around the barrier.</p>
</blockquote>
<p><strong>Any - Any</strong></p>
<blockquote>
<p>This means that <strong><em>both</em></strong> loads and stores must <strong>complete</strong> <em>before</em> the barrier.<br />
<strong><em>Both</em></strong> loads and stores that appear <em>after</em> the barrier in program order must <strong>wait</strong> for the barrier to complete.</p>
</blockquote>
<p>Barriers are used to <strong>prevent</strong> unsafe optimizations from occurring and to <strong>enforce</strong> a specific memory ordering. Use of unnecessary barrier instructions can therefore <strong>reduce</strong> software performance. Consider carefully whether a barrier is necessary in a specific situation, and if so, which is the correct barrier to use.</p>
<p>A more subtle effect of the ordering rules is that the instruction interface, data interface, and MMU table walker of a core are considered as separate observers. This means that you might need, for example, to use <code>DSB</code> instructions to <strong>ensure</strong> that an access one interface is <strong>guaranteed</strong> to be <em>observable</em> on a different interface.</p>
<p>If you execute a data cache clean and invalidate instruction, for example <code>DCCVAU, X0</code>, you must insert a <code>DSB</code> instruction after this to be sure that subsequent page table walks, modifications to translation table entries, instruction fetches, or updates to instructions in memory, can all see the new values.</p>
<p>For example, consider an update of the translation tables:</p>
<div class="language-asm highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="nf">STR</span><span class="w"> </span><span class="no">X0</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">X1</span><span class="p">]</span><span class="w">    </span><span class="c1">// update a translation table entry</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="nf">DSB</span><span class="w"> </span><span class="no">ISHST</span><span class="w">       </span><span class="c1">// ensure write has completed</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="nf">TLBI</span><span class="w"> </span><span class="no">VAE1IS</span><span class="p">,</span><span class="w"> </span><span class="no">X2</span><span class="w"> </span><span class="c1">// invalidate the TLB entry for the entry that changes</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="nf">DSB</span><span class="w"> </span><span class="no">ISH</span><span class="w">         </span><span class="c1">// ensure TLB invalidation is complete</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="nf">ISB</span><span class="w">             </span><span class="c1">// synchronize context on this processor</span>
</span></code></pre></div>
<p>A <code>DSB</code> is required to ensure that the maintenance operations complete and an <code>ISB</code> is required to ensure that the effects of those operations are seen by the instructions that <em>follow</em>.</p>
<p>The processor might speculatively access an address marked as Normal at <em>any</em> time. So when considering whether barriers are required, don’t just consider explicit accesses generated by load or store instructions.</p>
<h2 id="barrier_usage_scenarios">barrier usage scenarios<a class="headerlink" href="#barrier_usage_scenarios" title="Permanent link">#</a></h2>
<p>In most scenarios, we don't need to pay special attention to memory barriers. Especially in single-processor systems, although the CPU supports out-of-order execution and predictive execution, in general, the CPU will ensure that the final execution result meets the programmer's requirements. In the scenario of multi-core concurrent programming, programmers need to consider whether to use memory barrier instructions. The following are some typical scenarios where you need to consider using memory barrier instructions.</p>
<ul>
<li>Share data between multiple CPU cores. Under the weak consistency memory model, a CPU's disordered memory access order may cause contention access.</li>
<li>Perform operations related to peripherals, such as DMA operations. The process of starting DMA operations is usually as follows: the first step is to write data to the DMA buffer; the second step is to set DMA-related registers to start DMA. If there is no memory barrier instruction in the middle, the related operations of the second step may be executed before the first step, so that DMA transmits wrong data.</li>
<li>Modify the memory management strategy, such as context switching, requesting page faults, and modifying page tables.</li>
<li>Modify the memory area where instructions are stored, such as the scenario of self-modifying code.</li>
</ul>
<p>In short, the purpose of using memory barrier instructions is to make the CPU execute according to the logic of the program code, rather than having the execution order of the code disrupted by the CPU's out-of-order execution and speculative execution.</p>
<h2 id="references">references<a class="headerlink" href="#references" title="Permanent link">#</a></h2>
<p><a href="https://blog.csdn.net/chen19870707/article/details/39896655">为什么需要内存屏障？</a><br />
内存避障：<a href="https://blog.csdn.net/jackgo73/article/details/129580683">一个内存乱序实例</a> &amp; <a href="https://mingjie.blog.csdn.net/article/details/129588953">前世今生</a><br />
浅墨: 聊聊原子变量、锁、内存屏障那点事：<a href="https://cloud.tencent.com/developer/article/1518180">（1）</a>，<a href="https://cloud.tencent.com/developer/article/1517889">（2）</a></p>
<p><a href="https://blog.chongsheng.art/post/golang/cpu-cache-memory-barrier/">从CPU缓存架构、内存一致性到内存屏障</a><br />
<a href="https://www.cnblogs.com/yungyu16/p/13200453.html">从缓存一致性、指令重排、内存屏障到volatile</a></p>
<p><a href="https://blog.csdn.net/s2603898260/article/details/109234770">什么是内存屏障？</a> - MESI, <a href="https://blog.csdn.net/wll1228/article/details/107775976">Store Buffer, Invalid Queue</a><br />
理解内存屏障及应用实例无锁环形队列kfifo：<a href="https://www.cnblogs.com/my_life/articles/5220172.html">bw_0927</a>，<a href="https://www.cnblogs.com/moodlxs/p/10718706.html">绿色冰点</a></p>







  
  



  


  



  <h2 id="__comments">Comments</h2>
  <!-- Insert generated snippet here -->
  <script src="https://giscus.app/client.js"
    data-repo="fan2/mkdocs"
    data-repo-id="R_kgDOLltxSg"
    data-category="Announcements"
    data-category-id="DIC_kwDOLltxSs4CeURH"
    data-mapping="pathname"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="1"
    data-input-position="top"
    data-theme="preferred_color_scheme"
    data-lang="en"
    data-loading="lazy"
    crossorigin="anonymous"
    async>
  </script>

  <!-- Synchronize Giscus theme with palette -->
  <script>
    var giscus = document.querySelector("script[src*=giscus]")

    // Set palette on initial load
    var palette = __md_get("__palette")
    if (palette && typeof palette.color === "object") {
      var theme = palette.color.scheme === "slate"
        ? "transparent_dark"
        : "light"

      // Instruct Giscus to set theme
      giscus.setAttribute("data-theme", theme) 
    }

    // Register event handlers after documented loaded
    document.addEventListener("DOMContentLoaded", function() {
      var ref = document.querySelector("[data-md-component=palette]")
      ref.addEventListener("change", function() {
        var palette = __md_get("__palette")
        if (palette && typeof palette.color === "object") {
          var theme = palette.color.scheme === "slate"
            ? "transparent_dark"
            : "light"

          // Instruct Giscus to change theme
          var frame = document.querySelector(".giscus-frame")
          frame.contentWindow.postMessage(
            { giscus: { setConfig: { theme } } },
            "https://giscus.app"
          )
        }
      })
    })
  </script>

      
    </article>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
        
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../c-pointer-array-crossref/" class="md-footer__link md-footer__link--prev" aria-label="Previous: C Pointer and Array Cross Reference with Mismatched Type">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                C Pointer and Array Cross Reference with Mismatched Type
              </div>
            </div>
          </a>
        
        
          
          <a href="../a64-oneway-barrier/" class="md-footer__link md-footer__link--next" aria-label="Next: ARM64 One-Way Barriers">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                ARM64 One-Way Barriers
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2024- Cliff Fan
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["toc.follow", "header.autohide", "navigation.tabs", "navigation.top", "navigation.footer", "navigation.tracking", "content.code.copy", "content.code.select", "content.code.annotate"], "search": "../../../assets/javascripts/workers/search.07f07601.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.56dfad97.min.js"></script>
      
        <script src="../../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="https://vercount.one/js"></script>
      
    
  </body>
</html>