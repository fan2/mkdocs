
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="在别处或在路上">
      
      
        <meta name="author" content="Cliff Fan">
      
      
        <link rel="canonical" href="https://duetorun.com/blog/20230614/arm-stack-modes/">
      
      
        <link rel="prev" href="../../20230613/arm-addressing-modes/">
      
      
        <link rel="next" href="../../20230615/gas-directives/">
      
      
      <link rel="icon" href="../../../assets/hold_yourself.jpg">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.27">
    
    
      
        <title>ARM Push/Pop Stack Modes - ElseWhere</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.6543a935.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-XGW41EGL31"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-XGW41EGL31",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-XGW41EGL31",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  

  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#stack_modes" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../../.." title="ElseWhere" class="md-header__button md-logo" aria-label="ElseWhere" data-md-component="logo">
      
  <img src="../../../assets/hold_yourself.jpg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            ElseWhere
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              ARM Push/Pop Stack Modes
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1M8 13h8v-2H8v2m9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1 0 1.71-1.39 3.1-3.1 3.1h-4V17h4a5 5 0 0 0 5-5 5 5 0 0 0-5-5Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="indigo"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5M7 15a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../about/" class="md-tabs__link">
        
  
    
  
  About

      </a>
    </li>
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../" class="md-tabs__link">
          
  
  Blog

        </a>
      </li>
    
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../link/" class="md-tabs__link">
        
  
    
  
  Link

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
                
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" hidden>
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="ElseWhere" class="md-nav__button md-logo" aria-label="ElseWhere" data-md-component="logo">
      
  <img src="../../../assets/hold_yourself.jpg" alt="logo">

    </a>
    ElseWhere
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../about/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    About
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Blog
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Blog
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      <a href="../../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Blog
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Archive
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            Archive
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2024/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2023/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2022/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2021/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2021
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2020/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2020
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2019/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2019
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2018/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2018
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2017/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2017
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2015/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2015
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2009/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2009
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3" >
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Categories
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            Categories
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/cs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/arm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    arm
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/c/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    c
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/cpp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cpp
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/editor/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    editor
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/elf/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    elf
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/excerpt/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    excerpt
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/git/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    git
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/linux/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    linux
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/macos/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    macOS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/markdown/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    markdown
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/material/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    material
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/mkdocs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    mkdocs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/nginx/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    nginx
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/python/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    python
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/resource/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    resource
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/shell/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    shell
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/toolchain/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    toolchain
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/ubuntu/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ubuntu
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/vim/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    vim
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/webdav/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    webDAV
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/wiki/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    wiki
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/zsh/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    zsh
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../link/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Link
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
                
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#stack_modes" class="md-nav__link">
    <span class="md-ellipsis">
      stack modes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="stack modes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#suffixes" class="md-nav__link">
    <span class="md-ellipsis">
      suffixes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#defaultfd" class="md-nav__link">
    <span class="md-ellipsis">
      default(FD)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pushpop" class="md-nav__link">
    <span class="md-ellipsis">
      PUSH/POP
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aapcs64_stack" class="md-nav__link">
    <span class="md-ellipsis">
      aapcs64 stack
    </span>
  </a>
  
    <nav class="md-nav" aria-label="aapcs64 stack">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#activity" class="md-nav__link">
    <span class="md-ellipsis">
      activity
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#constraints" class="md-nav__link">
    <span class="md-ellipsis">
      constraints
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#frame_pointer" class="md-nav__link">
    <span class="md-ellipsis">
      Frame Pointer
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#stack_equiv" class="md-nav__link">
    <span class="md-ellipsis">
      stack equiv
    </span>
  </a>
  
    <nav class="md-nav" aria-label="stack equiv">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#implementation" class="md-nav__link">
    <span class="md-ellipsis">
      implementation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prologepilog" class="md-nav__link">
    <span class="md-ellipsis">
      prolog/epilog
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#refs" class="md-nav__link">
    <span class="md-ellipsis">
      refs
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content md-content--post" data-md-component="content">
    <div class="md-sidebar md-sidebar--post" data-md-component="sidebar" data-md-type="navigation">
      <div class="md-sidebar__scrollwrap">
        <div class="md-sidebar__inner md-post">
          <nav class="md-nav md-nav--primary">
            <div class="md-post__back">
              <div class="md-nav__title md-nav__container">
                <a href="../../" class="md-nav__link">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
                  <span class="md-ellipsis">
                    回到主页
                  </span>
                </a>
              </div>
            </div>
            
              <div class="md-post__authors md-typeset">
                
                  <div class="md-profile md-post__profile">
                    <span class="md-author md-author--long">
                      <img src="https://duetorun.com/assets/carve_yourself.jpg" alt="Cliff Fan">
                    </span>
                    <span class="md-profile__description">
                      <strong>
                        
                          Cliff Fan
                        
                      </strong>
                      <br>
                      Just do IT
                    </span>
                  </div>
                
              </div>
            
            <ul class="md-post__meta md-nav__list">
              <li class="md-nav__item md-nav__item--section">
                <div class="md-post__title">
                  <span class="md-ellipsis">
                    元数据
                  </span>
                </div>
                <nav class="md-nav">
                  <ul class="md-nav__list">
                    <li class="md-nav__item">
                      <div class="md-nav__link">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 19H5V8h14m-3-7v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-1V1m-1 11h-5v5h5v-5Z"/></svg>
                        <time datetime="2023-06-14 10:00:00" class="md-ellipsis">2023年6月14日</time>
                      </div>
                    </li>
                    
                    
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 3v15h3V3H9m3 2 4 13 3-1-4-13-3 1M5 5v13h3V5H5M3 19v2h18v-2H3Z"/></svg>
                          <span class="md-ellipsis">
                            分类于
                            
                              <a href="../../category/arm/">arm</a></span>
                        </div>
                      </li>
                    
                    
                      
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20a8 8 0 0 0 8-8 8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8m0-18a10 10 0 0 1 10 10 10 10 0 0 1-10 10C6.47 22 2 17.5 2 12A10 10 0 0 1 12 2m.5 5v5.25l4.5 2.67-.75 1.23L11 13V7h1.5Z"/></svg>
                          <span class="md-ellipsis">
                            
                              需要 11 分钟阅读时间
                            
                          </span>
                        </div>
                      </li>
                    
                    <!-- Add by Cliff.Fan, 29Mar24. -->
                    <li class="md-nav__item">
                      <div class="md-nav__link">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m19 1-5 5v11l5-4.5V1m2 4v13.5c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5V6c-1.45-1.1-3.55-1.5-5.5-1.5-1.95 0-4.05.4-5.5 1.5v14.65c0 .25.25.5.5.5.1 0 .15-.05.25-.05C3.1 20.45 5.05 20 6.5 20c1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.3 4.75 1.05.1.05.15.05.25.05.25 0 .5-.25.5-.5V6c-.6-.45-1.25-.75-2-1M10 18.41C8.75 18.09 7.5 18 6.5 18c-1.06 0-2.32.19-3.5.5V7.13c.91-.4 2.14-.63 3.5-.63 1.36 0 2.59.23 3.5.63v11.28Z"/></svg>
                        <span class="md-ellipsis" id="busuanzi_container_page_pv">
                          阅读量：<span id="busuanzi_value_page_pv">N/A</span>
                        </span>
                      </div>
                    </li>
                  </ul>
                </nav>
              </li>
            </ul>
          </nav>
          
        </div>
      </div>
    </div>
    <article class="md-content__inner md-typeset">
      
        


  <h1>ARM Push/Pop Stack Modes</h1>

<p>In this article, we'll explore the stack modes, activities and accesses in ARM(A32/A64).</p>
<!-- more -->

<h2 id="stack_modes">stack modes<a class="headerlink" href="#stack_modes" title="Permanent link">#</a></h2>
<p><a href="https://developer.arm.com/documentation/dui0801/latest">Arm Compiler armasm User Guide</a> | 7. Writing A32/T32 Assembly Language - 7.16 Stack implementation using LDM and STM</p>
<p>You can use the <code>LDM</code> and <code>STM</code> instructions to implement pop and push operations respectively. You use a suffix to indicate the stack type.</p>
<p>The load and store multiple instructions can update the base register. For stack operations, the base register is usually the stack pointer, SP. This means that you can use these instructions to implement push and pop operations for any number of registers in a single instruction.</p>
<p>The load and store multiple instructions can be used with several types of stack:</p>
<p><strong>Descending or ascending</strong></p>
<p>The stack grows downwards, starting with a high address and progressing to a lower one (a <code>descending</code> stack), or upwards, starting from a low address and progressing to a higher address (an <code>ascending</code> stack).</p>
<p><strong>Full or empty</strong></p>
<p>The stack pointer can either point to the last item in the stack (a <code>full</code> stack), or the next free space on the stack (an <code>empty</code> stack).</p>
<h3 id="suffixes">suffixes<a class="headerlink" href="#suffixes" title="Permanent link">#</a></h3>
<p>To make it easier for the programmer, stack-oriented suffixes can be used instead of the increment or decrement, and before or after suffixes. The following table shows the stack-oriented suffixes and their equivalent addressing mode suffixes for load and store instructions:</p>
<p>Table 1. Stack-oriented suffixes and equivalent addressing mode suffixes</p>
<table>
<thead>
<tr>
<th>Stack-oriented suffix</th>
<th>For store or push instructions</th>
<th>For load or pop instructions</th>
</tr>
</thead>
<tbody>
<tr>
<td>FD (Full Descending stack)</td>
<td>DB (Decrement Before)</td>
<td>IA (Increment After)</td>
</tr>
<tr>
<td>FA (Full Ascending stack)</td>
<td>IB (Increment Before)</td>
<td>DA (Decrement After)</td>
</tr>
<tr>
<td>ED (Empty Descending stack)</td>
<td>DA (Decrement After)</td>
<td>IB (Increment Before)</td>
</tr>
<tr>
<td>EA (Empty Ascending stack)</td>
<td>IA (Increment After)</td>
<td>DB (Decrement Before)</td>
</tr>
</tbody>
</table>
<p>The following table shows the load and store <em>multiple</em> instructions with the stack-oriented suffixes for the various stack types:</p>
<p>Table 2. Suffixes for load and store multiple instructions</p>
<table>
<thead>
<tr>
<th>Stack type</th>
<th>Store</th>
<th>Load</th>
</tr>
</thead>
<tbody>
<tr>
<td>Full descending</td>
<td><code>STMFD</code> (<code>STMDB</code>, Decrement Before)</td>
<td><code>LDMFD</code> (<code>LDM</code>, increment after)</td>
</tr>
<tr>
<td>Full ascending</td>
<td><code>STMFA</code> (<code>STMIB</code>, Increment Before)</td>
<td><code>LDMFA</code> (<code>LDMDA</code>, Decrement After)</td>
</tr>
<tr>
<td>Empty descending</td>
<td><code>STMED</code> (<code>STMDA</code>, Decrement After)</td>
<td><code>LDMED</code> (<code>LDMIB</code>, Increment Before)</td>
</tr>
<tr>
<td>Empty ascending</td>
<td><code>STMEA</code> (<code>STM</code>, increment after)</td>
<td><code>LDMEA</code> (<code>LDMDB</code>, Decrement Before)</td>
</tr>
</tbody>
</table>
<p>Full Ascending:</p>
<ul>
<li><a href="https://developer.arm.com/documentation/ddi0597/2024-03/Base-Instructions/STMIB--STMFA--Store-Multiple-Increment-Before--Full-Ascending--">STMIB, STMFA: Store Multiple Increment Before (Full Ascending)</a></li>
<li><a href="https://developer.arm.com/documentation/ddi0597/2024-03/Base-Instructions/LDMDA--LDMFA--Load-Multiple-Decrement-After--Full-Ascending--">LDMDA, LDMFA: Load Multiple Decrement After (Full Ascending)</a></li>
</ul>
<p>Empty Descending:</p>
<ul>
<li><a href="https://developer.arm.com/documentation/ddi0597/2024-03/Base-Instructions/STMDA--STMED--Store-Multiple-Decrement-After--Empty-Descending--">STMDA, STMED: Store Multiple Decrement After (Empty Descending)</a></li>
<li><a href="https://developer.arm.com/documentation/ddi0597/2024-03/Base-Instructions/LDMIB--LDMED--Load-Multiple-Increment-Before--Empty-Descending--">LDMIB, LDMED: Load Multiple Increment Before (Empty Descending)</a></li>
</ul>
<p>Empty Ascending:</p>
<ul>
<li><a href="https://developer.arm.com/documentation/ddi0597/2024-03/Base-Instructions/STM--STMIA--STMEA--Store-Multiple--Increment-After--Empty-Ascending--">STM, STMIA, STMEA: Store Multiple (Increment After, Empty Ascending)</a></li>
<li><a href="https://developer.arm.com/documentation/ddi0597/2024-03/Base-Instructions/LDMDB--LDMEA--Load-Multiple-Decrement-Before--Empty-Ascending--">LDMDB, LDMEA: Load Multiple Decrement Before (Empty Ascending)</a></li>
</ul>
<h3 id="defaultfd">default(FD)<a class="headerlink" href="#defaultfd" title="Permanent link">#</a></h3>
<p>The Procedure Call Standard for the Arm Architecture (AAPCS), and <code>armclang</code> always use a <em><code>full descending</code></em> stack.</p>
<p>The <code>PUSH</code> and <code>POP</code> instructions assume a <em><code>full descending</code></em> stack. They are the preferred synonyms for <code>STMDB</code> and <code>LDM</code> with writeback.</p>
<p><strong>Push</strong>: decrement <code>sp</code> then put item on stack – pre-decrement, e.g. <em>stmfd</em>. <a href="https://developer.arm.com/documentation/ddi0597/2024-03/Base-Instructions/STMDB--STMFD--Store-Multiple-Decrement-Before--Full-Descending--">STMDB, STMFD: Store Multiple Decrement Before (Full Descending)</a>.</p>
<p>Store Multiple Decrement Before (Full Descending) stores multiple registers to consecutive memory locations using an address from a base register. The consecutive memory locations end just below this address, and the address of the first of those locations can optionally be written back to the base register.</p>
<p><strong>Pop</strong>: copy item from stack then increment <code>sp</code> – post-increment, e.g. <em>ldmfd</em>. <a href="https://developer.arm.com/documentation/ddi0597/2024-03/Base-Instructions/LDM--LDMIA--LDMFD--Load-Multiple--Increment-After--Full-Descending--">LDM, LDMIA, LDMFD: Load Multiple (Increment After, Full Descending)</a>.</p>
<p>Load Multiple (Increment After, Full Descending) loads multiple registers from consecutive memory locations using an address from a base register. The consecutive memory locations start at this address, and the address just above the highest of those locations can optionally be written back to the base register.</p>
<p>For example:</p>
<div class="language-asm highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="w">    </span><span class="nf">STMFD</span><span class="w">    </span><span class="no">sp</span><span class="p">!,</span><span class="w"> </span><span class="p">{</span><span class="no">r0-r5</span><span class="p">}</span><span class="w">  </span><span class="c1">; Push onto a Full Descending Stack</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="w">    </span><span class="nf">LDMFD</span><span class="w">    </span><span class="no">sp</span><span class="p">!,</span><span class="w"> </span><span class="p">{</span><span class="no">r0-r5</span><span class="p">}</span><span class="w">  </span><span class="c1">; Pop from a Full Descending Stack</span>
</span></code></pre></div>
<h3 id="pushpop">PUSH/POP<a class="headerlink" href="#pushpop" title="Permanent link">#</a></h3>
<p><a href="https://developer.arm.com/documentation/ddi0597/2024-03/Base-Instructions/PUSH--single-register---Push-Single-Register-to-Stack--an-alias-of-STR--immediate--">PUSH (single register): an alias of STR (immediate)</a></p>
<p>It's equivalent to <code>STR{&lt;c&gt;}{&lt;q&gt;} &lt;Rt&gt;, [SP, #-4]!</code>and is always the preferred disassembly.</p>
<p><a href="https://developer.arm.com/documentation/ddi0597/2024-03/Base-Instructions/PUSH--Push-Multiple-Registers-to-Stack-">PUSH: Push Multiple Registers to Stack</a> - <a href="https://developer.arm.com/documentation/ddi0597/2024-03/Base-Instructions/PUSH--multiple-registers---Push-multiple-registers-to-Stack--an-alias-of-STMDB--STMFD-">PUSH (multiple registers): an alias of STMDB, STMFD</a></p>
<p>Push Multiple Registers to Stack stores multiple general-purpose registers to the stack, storing to consecutive memory locations ending just below the address in SP, and updates SP to point to the start of the stored data.</p>
<p>The lowest-numbered register is stored to the lowest memory address, through to the highest-numbered register to the highest memory address. See also <a href="https://developer.arm.com/documentation/ddi0487/latest">Encoding of lists of general-purpose registers and the PC</a>.</p>
<hr />
<p><a href="https://developer.arm.com/documentation/ddi0597/2024-03/Base-Instructions/POP--single-register---Pop-Single-Register-from-Stack--an-alias-of-LDR--immediate--">POP (single register): an alias of LDR (immediate)</a></p>
<p>It's equivalent to <code>LDR{&lt;c&gt;}{&lt;q&gt;} &lt;Rt&gt;, [SP], #4</code> and is always the preferred disassembly.</p>
<p><a href="https://developer.arm.com/documentation/ddi0597/2024-03/Base-Instructions/POP--Pop-Multiple-Registers-from-Stack-">POP: Pop Multiple Registers from Stack</a> - <a href="https://developer.arm.com/documentation/ddi0597/2024-03/Base-Instructions/POP--multiple-registers---Pop-Multiple-Registers-from-Stack--an-alias-of-LDM--LDMIA--LDMFD-">POP (multiple registers): an alias of LDM, LDMIA, LDMFD</a></p>
<p>Pop Multiple Registers from Stack loads multiple general-purpose registers from the stack, loading from consecutive memory locations starting at the address in SP, and updates SP to point just above the loaded data.</p>
<p>The lowest-numbered register is loaded from the lowest memory address, through to the highest-numbered register from the highest memory address. See also <a href="https://developer.arm.com/documentation/ddi0487/latest">Encoding of lists of general-purpose registers and the PC</a>.</p>
<hr />
<p>The push and pop operations are store many and load many op codes, the assumption being that a function will need to <em>save</em> and <em>restore</em> the contents of several registers that it is likely to corrupt (of course it is possible to deal with just one register!). </p>
<p>When a list of registers is given the <em>lowest</em> numbered register uses the <em>lowest</em> stack memory location and the <em>highest</em> numbered register uses the <em>highest</em> stack memory location. This is true no matter what order we specify the registers!</p>
<p>The important thing is to remember whether the stack pointer is altered <code>pre</code>- or <code>post</code>- before the multiple registers are dealt with!</p>
<h2 id="aapcs64_stack">aapcs64 stack<a class="headerlink" href="#aapcs64_stack" title="Permanent link">#</a></h2>
<p><a href="https://github.com/ARM-software/abi-aa/blob/2a70c42d62e9c3eb5887fa50b71257f20daca6f9/aapcs64/aapcs64.rst">aapcs64</a> | 6 The Base Procedure Call Standard - 6.4 Memory and the Stack - 6.4.5 The Stack</p>
<p>Each thread has a stack. This stack is a contiguous area of memory that the thread may use for storage of local variables and for passing additional arguments to subroutines when there are insufficient argument registers available.</p>
<p>The stack is defined in terms of three values:</p>
<ul>
<li>a base (Lbound?)</li>
<li>a limit (Ubound?)</li>
<li>the <em>current</em> stack extent, stored in the special-purpose register <code>SP</code></li>
</ul>
<figure><br />
<img alt="Shared Stack-Usage Rules" src="https://community.arm.com/cfs-file/__key/communityserver-blogs-components-weblogfiles/00-00-00-21-42/5808.memory_2D00_layout.png" /><br />
    <figcaption>Shared Stack-Usage Rules</figcaption><br />
</figure>
<h3 id="activity">activity<a class="headerlink" href="#activity" title="Permanent link">#</a></h3>
<p>The SP moves from the base to the limit as the stack <em>grows</em>, and from the limit to the base as the stack <em>shrinks</em>. In practice, an application might not be able to determine the value of either the base or the limit.</p>
<p>In the description below, the base, limit, and current stack extent for a thread T are denoted <code>T.base</code>, <code>T.limit</code>, and <code>T.SP</code> respectively.</p>
<p>The stack implementation is <strong>full-descending</strong>(<code>FD</code>), so that for each thread T:</p>
<ul>
<li><span class="arithmatex">\(T.limit &lt; T.base\)</span> and the stack occupies the area of memory delimited by the half-open internal <span class="arithmatex">\([T.limit, T.base)\)</span>.</li>
<li>The <em>active</em> region of T's stack is the area of memory delimited by the half-open interval <span class="arithmatex">\([T.SP, T.base)\)</span>. The active region is (initial) empty when T.SP is <em>equal</em> to T.base.</li>
<li>The <em>inactive</em> region of T's stack is the area of memory denoted by the half-open interval <span class="arithmatex">\([T.limit, T.SP)\)</span>. The inactive region is empty when T.SP is <em>equal</em> to T.limit.</li>
</ul>
<p>The stack may have a fixed size or be dynamically <em>extendable</em> (by adjusting the stack-limit <em>downwards</em>, towards lower addresses).</p>
<p>The rules for maintenance of the stack are divided into two parts: a set of constraints that must be observed at all times, and an additional constraint that must be observed at a public interface.</p>
<h3 id="constraints">constraints<a class="headerlink" href="#constraints" title="Permanent link">#</a></h3>
<p>At public interfaces, the alignment of stack-pointer(sp) must be two times the pointer size.</p>
<blockquote>
<p>For AArch32 that's <em>8</em> bytes, and for AArch64 it's <em>16</em> bytes.</p>
</blockquote>
<p>For AArch32 (ARM or Thumb), sp must be at least 4-byte aligned at all times.<br />
For AArch64, sp must be 16-byte aligned whenever it is used to access memory.</p>
<p>6.4.5.1 <strong>Universal stack constraints</strong></p>
<p>At all times during the execution of a thread T, the following basic constraints must hold for its stack <em>S</em>:</p>
<ul>
<li>
<p><span class="arithmatex">\(T.limit ≤ T.SP ≤ T.base\)</span>. T's stack pointer must lie within the extent of the memory occupied by <em>S</em>.</p>
</li>
<li>
<p>No thread is permitted to access (for reading or for writing) the inactive region of <em>S</em>.</p>
</li>
<li>
<p>If MTE is enabled, then the tag stored in <code>T.SP</code> must match the tag set on the inactive region of <em>S</em>.</p>
</li>
</ul>
<p>Additionally, at any point at which memory is accessed via <code>SP</code>, the hardware requires that</p>
<ul>
<li><span class="arithmatex">\(SP\ mod\ 16 = 0\)</span>. The stack must be quad-word aligned.</li>
</ul>
<p>6.4.5.2 <strong>Stack constraints at a public interface</strong></p>
<p>The stack must also conform to the following constraint at a public interface:</p>
<ul>
<li><span class="arithmatex">\(SP\ mod\ 16 = 0\)</span>. The stack must be quad-word aligned.</li>
</ul>
<h3 id="frame_pointer">Frame Pointer<a class="headerlink" href="#frame_pointer" title="Permanent link">#</a></h3>
<p>6.4.6 <strong>The Frame Pointer</strong></p>
<p>Conforming code shall construct a <em>linked</em> list of <code>stack-frames</code>. Each frame shall <strong>link</strong> to the frame of its caller by means of a frame record of <em>two</em> 64-bit values on the stack (independent of the data model). The frame record for the innermost frame (belonging to the most recent routine invocation) shall be pointed to by the frame pointer register (<code>FP</code>, X29 in AArch64). The lowest addressed double-word shall point to the <em>previous</em> frame record and the highest(next to FP?) addressed double-word shall contain the value passed in <code>LR</code>(X30 in AArch64) on entry to the current function. If code uses the pointer signing extension to sign return addresses, the value in <code>LR</code> must be signed before storing it in the frame record. The end of the frame record <em>chain</em> is indicated by the address zero in the address for the previous frame. The location of the frame record within a stack frame is not specified.</p>
<div class="admonition note">
<p class="admonition-title">sp sem break moment</p>
<p>There will always be a short period during construction or destruction of each frame record during which the frame pointer will point to the caller’s record.</p>
</div>
<p>A platform shall mandate the minimum level of conformance with respect to the maintenance of frame records. The options are, in decreasing level of functionality:</p>
<ul>
<li>
<p>It may require the frame pointer to address a valid frame record at all times, except that small subroutines which do not modify the link register may elect not to create a frame record</p>
</li>
<li>
<p>It may require the frame pointer to address a valid frame record at all times, except that any subroutine may elect not to create a frame record</p>
</li>
<li>
<p>It may permit the frame pointer register to be used as a general-purpose callee-saved register, but provide a platform-specific mechanism for external agents to reliably detect this condition</p>
</li>
<li>
<p>It may elect not to maintain a frame chain and to use the frame pointer register as a general-purpose callee-saved register.</p>
</li>
</ul>
<h2 id="stack_equiv">stack equiv<a class="headerlink" href="#stack_equiv" title="Permanent link">#</a></h2>
<h3 id="implementation">implementation<a class="headerlink" href="#implementation" title="Permanent link">#</a></h3>
<p>For AArch64, sp must be 16-byte aligned whenever it is used to access memory. This is enforced by AArch64 hardware.</p>
<ul>
<li>This means that it is difficult to implement a generic <code>push</code> or <code>pop</code> operation for AArch64. There are no <code>push</code> or <code>pop</code> aliases like there are for ARM and Thumb.</li>
<li>The hardware checks can be disabled by privileged code, but they're enabled in at least Linux and Android.</li>
</ul>
<p>The alignment-check-on-memory-access means that AArch64 <strong>cannot</strong> have general-purpose push- or pop-like operations.</p>
<p>If you're dealing with hand-written AArch64 assembly code, you'll have to be aware of these limitation. Whenever the stack pointer is used as the base register in an address operand, it must have 16-byte alignment.</p>
<p>For example:</p>
<div class="language-asm highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="c1">// Broken AArch64 implementation of `push {x1}; push {x0};`.</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="w">    </span><span class="nf">x1</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">#-8</span><span class="p">]!</span><span class="w"> </span><span class="c1">// This works, but leaves `sp` with 8-byte alignment ...</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="w">    </span><span class="nf">x0</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">#-8</span><span class="p">]!</span><span class="w"> </span><span class="c1">// ... so the second `str` will fail.</span>
</span></code></pre></div>
<p>In this particular case, the stores could be combined:</p>
<div class="language-asm highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1">// AArch64 implementation of `push {x0, x1}`.</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="w">    </span><span class="nf">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">#-16</span><span class="p">]!</span>
</span></code></pre></div>
<p>However, in a simple compiler, it is not always easy to combine instructions in that way.</p>
<p>The alignment checks can be very inconvenient in code generators where it is not feasible to determine how much stack space a function will require. Many JIT compilers fall into this category; they tend to rely on being able to push individual values to the stack.</p>
<ol>
<li>Calculate stack sizes in advance</li>
<li>Use 16-byte stack slots</li>
<li>
<p>Use a register other than <code>sp</code> as the stack pointer</p>
<ul>
<li>Separate stack area</li>
<li>Reserve stack space in advance</li>
<li>Shadow <code>sp</code></li>
</ul>
</li>
</ol>
<h3 id="prologepilog">prolog/epilog<a class="headerlink" href="#prologepilog" title="Permanent link">#</a></h3>
<p><a href="https://developer.arm.com/documentation/dui0801/latest">Arm Compiler armasm User Guide</a> | 7. Writing A32/T32 Assembly Language - 7.17 Stack operations for nested subroutines</p>
<p>Stack operations can be very useful at subroutine entry and exit to avoid losing register contents if other subroutines are called.</p>
<p>At the <em>start</em> of a subroutine, any working registers required can be stored on the stack, and at <em>exit</em> they can be popped off again.</p>
<p>In addition, if the link register is pushed onto the stack at entry, additional subroutine calls can be made safely without causing the return address to be lost. If you do this, you can also return from a subroutine by popping the <code>PC</code> off the stack at exit, instead of popping the <code>LR</code> and then moving that value into the <code>PC</code>. For example:</p>
<div class="language-asm highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="nf">subroutine</span><span class="w">  </span><span class="no">PUSH</span><span class="w">    </span><span class="p">{</span><span class="no">r5-r7</span><span class="p">,</span><span class="no">lr</span><span class="p">}</span><span class="w"> </span><span class="c1">; Push work registers and lr</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="w">            </span><span class="c1">; code</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="w">            </span><span class="nf">BL</span><span class="w">      </span><span class="no">somewhere_else</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="w">            </span><span class="c1">; code</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="w">            </span><span class="nf">POP</span><span class="w">     </span><span class="p">{</span><span class="no">r5-r7</span><span class="p">,</span><span class="no">pc</span><span class="p">}</span><span class="w"> </span><span class="c1">; Pop work registers and pc</span>
</span></code></pre></div>
<p>The following snippet is a typical prolog/prelude and epilog/postlude of a subroutine disassembly.</p>
<div class="language-asm highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="c1">// pwndbg&gt; disassemble main</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="c1">// prolog/prelude</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="w">    </span><span class="err">0</span><span class="nf">x00000000004008e0</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">0</span><span class="err">&gt;</span><span class="p">:</span><span class="w">    </span><span class="no">stp</span><span class="w"> </span><span class="no">x29</span><span class="p">,</span><span class="w"> </span><span class="no">x30</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">#-48</span><span class="p">]!</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="w">    </span><span class="err">0</span><span class="nf">x00000000004008e4</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">4</span><span class="err">&gt;</span><span class="p">:</span><span class="w">    </span><span class="no">mov</span><span class="w"> </span><span class="no">x29</span><span class="p">,</span><span class="w"> </span><span class="no">sp</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="w">    </span><span class="err">[</span><span class="na">...armasm...</span><span class="p">]</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="c1">// epilog/postlude</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="w">    </span><span class="err">0</span><span class="nf">x000000000040094c</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">108</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">ldp</span><span class="w"> </span><span class="no">x29</span><span class="p">,</span><span class="w"> </span><span class="no">x30</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">sp</span><span class="p">],</span><span class="w"> </span><span class="mi">#48</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="w">    </span><span class="err">0</span><span class="nf">x0000000000400950</span><span class="w"> </span><span class="err">&lt;+</span><span class="mi">112</span><span class="err">&gt;</span><span class="p">:</span><span class="w">  </span><span class="no">ret</span>
</span></code></pre></div>
<p><code>stp x29, x30, [sp, #-48]!</code>:</p>
<ul>
<li><span class="arithmatex">\(sp \mathrel{-}= 48\)</span>: stack grows downwards with size=0x30, 16-byte aligned.</li>
<li>
<p>push FP &amp; LR to stack [sp], [sp+8]</p>
<div class="admonition note">
<p class="admonition-title">r2 expr of prolog</p>
<p>dr sp=`dr sp`-0x30<br />
wvp `dr x29` @ sp; wvp `dr x30` @ sp+8</p>
</div>
</li>
</ul>
<p><strong>Note</strong>: The <code>SP</code> remains the same as the <code>X29</code>/<code>FP</code> throughout the subroutine. The <code>FP</code> is not used and the <code>SP</code> is only used as a base register.</p>
<div class="admonition tip">
<p class="admonition-title">gcc -fomit-frame-poiter</p>
<p>If we explicitly indicate that we do not need <code>BP</code>/<code>FP</code> to provide stack frame information, the compiler can <em>omit</em> the actions of saving <code>BP</code>/<code>FP</code> after entering the procedure and restoring <code>BP</code>/<code>FP</code> before exiting the procedure, and use <code>SP</code> directly to address the parameters and internal variables of the procedure.</p>
<p>For the sake of pursuing higher performance, for example, when compiling the Linux kernel, you will find that the internal function is indeed addressed directly by <code>SP</code>.</p>
<p>For gcc and g++, you can use the <a href="https://gcc.gnu.org/onlinedocs/gcc/Optimize-Options.html">-fomit-frame-poiter</a> compilation option to instruct gcc to use <code>SP</code> addressing directly.</p>
<blockquote>
<p>Omit the frame pointer in functions that don't need one. This avoids the instructions to save, set up and restore the frame pointer; on many targets it also makes an extra register available.</p>
<p>On some targets this flag has no effect because the standard calling sequence always uses a frame pointer, so it cannot be omitted.</p>
</blockquote>
</div>
<p><code>ldp x29, x30, [sp], #48</code>:</p>
<ul>
<li>pop FP &amp; LR from stack [sp], [sp+8]</li>
<li>
<p><span class="arithmatex">\(sp \mathrel{+}= 48\)</span>: stack shrinks backward</p>
<div class="admonition note">
<p class="admonition-title">r2 expr of epilog</p>
<p>dr x29=pv@sp; dr x30=pv@sp+8<br />
dr sp=`dr sp`+0x30</p>
</div>
</li>
</ul>
<p><code>ret</code>(<code>RET {Xn}</code>): Return from subroutine</p>
<ul>
<li>Branches unconditionally to an address in a register.</li>
<li>Defaults to <code>X30</code>(LR) if absent.</li>
</ul>
<h2 id="refs">refs<a class="headerlink" href="#refs" title="Permanent link">#</a></h2>
<p><a href="../../20230314/calling-convention/">ABI &amp; Calling conventions</a><br />
<a href="../../20230601/a64-regs/">Register file of ARM64</a></p>
<p><a href="http://www.cems.uwe.ac.uk/~cduffy/es/ARMstacks.doc">Stacks on ARM processors</a><br />
<a href="https://community.arm.com/arm-community-blogs/b/architectures-and-processors-blog/posts/using-the-stack-in-aarch32-and-aarch64">Using the Stack in AArch32 and AArch64</a><br />
<a href="https://community.arm.com/arm-community-blogs/b/architectures-and-processors-blog/posts/using-the-stack-in-aarch64-implementing-push-and-pop">Using the Stack in AArch64: Implementing Push and Pop</a></p>







  
  



  


  



  <h2 id="__comments">评论</h2>
  <!-- Insert generated snippet here -->
  <script src="https://giscus.app/client.js"
    data-repo="fan2/mkdocs"
    data-repo-id="R_kgDOLltxSg"
    data-category="Announcements"
    data-category-id="DIC_kwDOLltxSs4CeURH"
    data-mapping="pathname"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="1"
    data-input-position="top"
    data-theme="preferred_color_scheme"
    data-lang="zh-CN"
    data-loading="lazy"
    crossorigin="anonymous"
    async>
  </script>

  <!-- Synchronize Giscus theme with palette -->
  <script>
    var giscus = document.querySelector("script[src*=giscus]")

    // Set palette on initial load
    var palette = __md_get("__palette")
    if (palette && typeof palette.color === "object") {
      var theme = palette.color.scheme === "slate"
        ? "transparent_dark"
        : "light"

      // Instruct Giscus to set theme
      giscus.setAttribute("data-theme", theme) 
    }

    // Register event handlers after documented loaded
    document.addEventListener("DOMContentLoaded", function() {
      var ref = document.querySelector("[data-md-component=palette]")
      ref.addEventListener("change", function() {
        var palette = __md_get("__palette")
        if (palette && typeof palette.color === "object") {
          var theme = palette.color.scheme === "slate"
            ? "transparent_dark"
            : "light"

          // Instruct Giscus to change theme
          var frame = document.querySelector(".giscus-frame")
          frame.contentWindow.postMessage(
            { giscus: { setConfig: { theme } } },
            "https://giscus.app"
          )
        }
      })
    })
  </script>

      
    </article>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  回到页面顶部
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
        
      
      <nav class="md-footer__inner md-grid" aria-label="页脚" >
        
          
          <a href="../../20230613/arm-addressing-modes/" class="md-footer__link md-footer__link--prev" aria-label="上一页: ARM Load/Store Addressing Modes">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                上一页
              </span>
              <div class="md-ellipsis">
                ARM Load/Store Addressing Modes
              </div>
            </div>
          </a>
        
        
          
          <a href="../../20230615/gas-directives/" class="md-footer__link md-footer__link--next" aria-label="下一页: GNU Assembler Directives">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                下一页
              </span>
              <div class="md-ellipsis">
                GNU Assembler Directives
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2024- Cliff Fan
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["toc.follow", "header.autohide", "navigation.tabs", "navigation.top", "navigation.footer", "navigation.tracking", "content.code.copy", "content.code.select", "content.code.annotate"], "search": "../../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.ad660dcc.min.js"></script>
      
        <script src="../../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="https://vercount.one/js"></script>
      
    
  </body>
</html>